# 智能商城系统架构图与流程图

> 项目：智能商城导购系统（Smart Mall Guide System）  
> 范围：前端架构可视化文档
> 
> 本文档提供系统架构的可视化图表，帮助理解系统设计与数据流向。
> 
> 最后更新：2024-12-20

---

## 目录

1. [系统整体架构](#1-系统整体架构)
2. [渲染引擎层 P2](#2-渲染引擎层-p2)
3. [领域场景层 P3](#3-领域场景层-p3)
4. [核心交互流程](#4-核心交互流程)

---

## 1. 系统整体架构

### 1.1 四层架构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     智能商城导购系统 - 前端架构总览                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  🎯 P4 业务协调层 (Orchestrator Layer) - 待开发                        │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐       │  │
│  │  │ ActionDispatcher│  │PermissionChecker│  │  StateManager   │       │  │
│  │  │   动作分发器     │  │   权限检查器     │  │   状态管理器    │       │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  🏢 P3 领域场景层 (Domain Layer) - 进行中 55%                          │  │
│  │                                                                       │  │
│  │   管理器 Managers          注册表 Registry          行为 Behaviors    │  │
│  │  ┌──────────────┐      ┌──────────────────┐     ┌─────────────────┐  │  │
│  │  │ MallManager  │      │SemanticRegistry  │     │HighlightBehavior│  │  │
│  │  │ FloorManager │      │  MeshRegistry    │     │NavigationBehavior│ │  │
│  │  │ StoreManager │      └──────────────────┘     │SceneQueryBehavior│⭐│  │
│  │  └──────────────┘                               └─────────────────┘  │  │
│  │                    工厂 Factory              事件 Events ⭐新增       │  │
│  │               ┌─────────────────────┐    ┌─────────────────────┐    │  │
│  │               │SemanticObjectFactory│    │ DomainEventHandler  │    │  │
│  │               └─────────────────────┘    │ DomainEventBus      │    │  │
│  │                                          └─────────────────────┘    │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  🎮 P2 渲染引擎层 (Engine Layer) - 完成 87.5%                          │  │
│  │                                                                       │  │
│  │   核心引擎           相机控制           对象管理          交互检测     │  │
│  │  ┌──────────┐    ┌─────────────┐   ┌─────────────┐   ┌────────────┐  │  │
│  │  │ThreeEngine│    │OrbitControl │   │ ObjectPool  │   │ Raycaster  │  │  │
│  │  │ 渲染循环  │    │CameraControl│   │GeometryFact │   │EventEmitter│  │  │
│  │  └──────────┘    └─────────────┘   └─────────────┘   └────────────┘  │  │
│  │                                                                       │  │
│  │   材质管理                          效果系统                          │  │
│  │  ┌─────────────────┐            ┌─────────────────┐                  │  │
│  │  │ MaterialManager │            │ HighlightEffect │                  │  │
│  │  │   材质缓存复用   │            │  悬停/选中高亮   │                  │  │
│  │  └─────────────────┘            └─────────────────┘                  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  📦 P1 类型系统层 (Types Layer) - 完成 92%                             │  │
│  │                                                                       │  │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐        │  │
│  │  │ 场景类型    │ │ 商城实体   │ │ 用户会话   │ │ 行为权限   │        │  │
│  │  │Vector3D    │ │Mall/Floor │ │User/Session│ │Action/Perm │        │  │
│  │  │BoundingBox │ │Area/Store │ │OnlineUser  │ │Context     │        │  │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 渲染引擎层 (P2)

### 2.1 ThreeEngine 核心架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          ThreeEngine 核心引擎                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        初始化流程                                    │   │
│   │                                                                      │   │
│   │    new ThreeEngine(container)                                       │   │
│   │           │                                                          │   │
│   │           ▼                                                          │   │
│   │    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐              │   │
│   │    │ Scene 场景   │   │Camera 相机  │   │Renderer渲染 │              │   │
│   │    │ 3D 世界容器  │   │透视/正交相机│   │WebGL 渲染器 │              │   │
│   │    └─────────────┘   └─────────────┘   └─────────────┘              │   │
│   │           │                 │                 │                      │   │
│   │           └─────────────────┼─────────────────┘                      │   │
│   │                             ▼                                        │   │
│   │                    ┌─────────────────┐                               │   │
│   │                    │   渲染循环启动   │                               │   │
│   │                    │   start()       │                               │   │
│   │                    └─────────────────┘                               │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      按需渲染策略                                    │   │
│   │                                                                      │   │
│   │     静止状态                    需要渲染                              │   │
│   │    ┌─────────┐               ┌─────────┐                            │   │
│   │    │needsRender│  ──触发──►  │needsRender│                           │   │
│   │    │ = false  │              │ = true   │                            │   │
│   │    └─────────┘               └─────────┘                            │   │
│   │         │                         │                                  │   │
│   │         ▼                         ▼                                  │   │
│   │    跳过渲染帧                执行渲染帧                               │   │
│   │    (省电省性能)              renderer.render()                       │   │
│   │                                                                      │   │
│   │    触发条件: 相机移动 / 对象变化 / 窗口resize / requestRender()      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 相机控制系统

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           相机控制系统                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────┐    ┌─────────────────────────────┐       │
│   │     OrbitController         │    │     CameraController        │       │
│   │       轨道控制器             │    │     第三人称跟随控制器       │       │
│   ├─────────────────────────────┤    ├─────────────────────────────┤       │
│   │                             │    │                             │       │
│   │  🖱️ 鼠标拖拽 → 旋转视角     │    │  🎯 跟随目标对象移动        │       │
│   │  🔄 滚轮滚动 → 缩放距离     │    │  📐 保持固定偏移距离        │       │
│   │  📏 边界限制 → 防止穿模     │    │  🔄 平滑过渡动画            │       │
│   │  🌊 阻尼惯性 → 自然手感     │    │                             │       │
│   │                             │    │                             │       │
│   │  适用: 建模模式/自由浏览    │    │  适用: 运行时/导航模式      │       │
│   └─────────────────────────────┘    └─────────────────────────────┘       │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        双相机模式切换                                │   │
│   │                                                                      │   │
│   │      orbit 模式                              follow 模式             │   │
│   │    ┌───────────────┐                      ┌───────────────┐         │   │
│   │    │   👁️          │    switchMode()     │      👁️       │         │   │
│   │    │    ╲          │   ◄────────────►    │       │        │         │   │
│   │    │     ╲         │                      │       │        │         │   │
│   │    │      🏢       │                      │      🚶        │         │   │
│   │    │   自由观察    │                      │   跟随角色     │         │   │
│   │    └───────────────┘                      └───────────────┘         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 对象管理与缓存

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         对象管理与缓存系统                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      ObjectPool 对象池                               │   │
│   │                                                                      │   │
│   │    问题: 频繁创建/销毁 3D 对象 → GC 压力大 → 卡顿                    │   │
│   │                                                                      │   │
│   │    解决方案:                                                         │   │
│   │    ┌─────────────────────────────────────────────────────────────┐  │   │
│   │    │                     对象池                                   │  │   │
│   │    │   ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                  │  │   │
│   │    │   │ 📦  │ │ 📦  │ │ 📦  │ │ 📦  │ │ 📦  │  预创建对象      │  │   │
│   │    │   └─────┘ └─────┘ └─────┘ └─────┘ └─────┘                  │  │   │
│   │    └─────────────────────────────────────────────────────────────┘  │   │
│   │              │                              ▲                        │   │
│   │    acquire() │                              │ release()              │   │
│   │    获取对象   ▼                              │ 归还对象               │   │
│   │         ┌─────────┐                    ┌─────────┐                   │   │
│   │         │  使用中  │  ──────────────►  │  归还   │                   │   │
│   │         └─────────┘                    └─────────┘                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                   GeometryFactory 几何体工厂                         │   │
│   │                                                                      │   │
│   │    ┌─────────────────┐                                              │   │
│   │    │   几何体缓存     │                                              │   │
│   │    │  ┌───────────┐  │     createBox(1,1,1)                         │   │
│   │    │  │"box_1_1_1"│──┼──►  先查缓存 → 有则复用 → 无则创建并缓存      │   │
│   │    │  │"box_2_2_2"│  │                                              │   │
│   │    │  │"plane_10" │  │     优势: 相同尺寸几何体只创建一次            │   │
│   │    │  └───────────┘  │            节省 GPU 内存                      │   │
│   │    └─────────────────┘                                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                   MaterialManager 材质管理器                         │   │
│   │                                                                      │   │
│   │    相同配置 → 复用材质实例                                           │   │
│   │                                                                      │   │
│   │    { color: 0xff0000, metalness: 0.5 }                              │   │
│   │              │                                                       │   │
│   │              ▼                                                       │   │
│   │    ┌─────────────────┐                                              │   │
│   │    │   材质缓存       │                                              │   │
│   │    │  key → Material │  →  同配置请求直接返回缓存实例                │   │
│   │    └─────────────────┘                                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.4 高亮效果系统

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        HighlightEffect 高亮效果                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        两种高亮模式                                  │   │
│   │                                                                      │   │
│   │    悬停高亮 (Hover)                    选中高亮 (Selected)           │   │
│   │   ┌─────────────────┐               ┌─────────────────┐             │   │
│   │   │                 │               │                 │             │   │
│   │   │    ░░░░░░░░░    │               │    ▓▓▓▓▓▓▓▓▓    │             │   │
│   │   │    ░░ 🏪 ░░    │               │    ▓▓ 🏪 ▓▓    │             │   │
│   │   │    ░░░░░░░░░    │               │    ▓▓▓▓▓▓▓▓▓    │             │   │
│   │   │                 │               │                 │             │   │
│   │   │   灰色微光      │               │   橙黄色发光    │             │   │
│   │   │   emissive:     │               │   emissive:     │             │   │
│   │   │   #444444       │               │   #ff8800       │             │   │
│   │   └─────────────────┘               └─────────────────┘             │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      状态保存与恢复                                  │   │
│   │                                                                      │   │
│   │    setHover(mesh)                                                   │   │
│   │         │                                                            │   │
│   │         ▼                                                            │   │
│   │    ┌─────────────────────────────────────────────────────────────┐  │   │
│   │    │  1. 保存原始材质状态                                         │  │   │
│   │    │     originalStates.set(mesh.uuid, {                         │  │   │
│   │    │       emissive: material.emissive.clone(),                  │  │   │
│   │    │       emissiveIntensity: material.emissiveIntensity         │  │   │
│   │    │     })                                                       │  │   │
│   │    │                                                              │  │   │
│   │    │  2. 应用高亮效果                                             │  │   │
│   │    │     material.emissive.set(hoverColor)                       │  │   │
│   │    │     material.emissiveIntensity = 0.3                        │  │   │
│   │    └─────────────────────────────────────────────────────────────┘  │   │
│   │                                                                      │   │
│   │    clearHover(mesh)                                                 │   │
│   │         │                                                            │   │
│   │         ▼                                                            │   │
│   │    ┌─────────────────────────────────────────────────────────────┐  │   │
│   │    │  从 originalStates 恢复原始材质状态                          │  │   │
│   │    └─────────────────────────────────────────────────────────────┘  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.5 交互检测系统

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          交互检测系统                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    RaycasterManager 射线检测                         │   │
│   │                                                                      │   │
│   │    用户点击屏幕                                                      │   │
│   │         │                                                            │   │
│   │         ▼                                                            │   │
│   │    ┌─────────────────────────────────────────────────────────────┐  │   │
│   │    │  屏幕坐标 (x, y)  →  标准化设备坐标 NDC (-1 ~ 1)             │  │   │
│   │    └─────────────────────────────────────────────────────────────┘  │   │
│   │         │                                                            │   │
│   │         ▼                                                            │   │
│   │    ┌─────────────────────────────────────────────────────────────┐  │   │
│   │    │                     射线投射                                 │  │   │
│   │    │                                                              │  │   │
│   │    │         👁️ Camera                                           │  │   │
│   │    │          ╲                                                   │  │   │
│   │    │           ╲  Ray (射线)                                      │  │   │
│   │    │            ╲                                                 │  │   │
│   │    │             ╲    ┌─────┐                                     │  │   │
│   │    │              ╲───│ 🏪 │ ← 命中! intersects[0]               │  │   │
│   │    │               ╲  └─────┘                                     │  │   │
│   │    │                ╲                                             │  │   │
│   │    │                 ╲  ┌─────┐                                   │  │   │
│   │    │                  ╲─│ 🏬 │ ← intersects[1]                   │  │   │
│   │    │                    └─────┘                                   │  │   │
│   │    └─────────────────────────────────────────────────────────────┘  │   │
│   │         │                                                            │   │
│   │         ▼                                                            │   │
│   │    返回: intersects[] 按距离排序的命中对象数组                       │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                  SceneEventEmitter 事件抽象层                        │   │
│   │                                                                      │   │
│   │    Three.js 底层事件  ──────────►  语义化场景事件                    │   │
│   │                                                                      │   │
│   │    ┌─────────────────┐          ┌─────────────────┐                 │   │
│   │    │ mousedown       │    →     │ click           │                 │   │
│   │    │ mousemove       │    →     │ hover / hoverEnd│                 │   │
│   │    └─────────────────┘          └─────────────────┘                 │   │
│   │                                                                      │   │
│   │    发布-订阅模式:                                                    │   │
│   │    emitter.on('click', (mesh) => { ... })                           │   │
│   │    emitter.on('hover', (mesh) => { ... })                           │   │
│   │    emitter.on('hoverEnd', (mesh) => { ... })                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 领域场景层 (P3)

### 3.1 领域层整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        领域场景层 (Domain Layer)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         管理器 (Managers)                            │   │
│  │                                                                      │   │
│  │    ┌─────────────────┐                                              │   │
│  │    │   MallManager   │ ←── 顶层管理器，协调子管理器                   │   │
│  │    │   商城管理器     │                                              │   │
│  │    └────────┬────────┘                                              │   │
│  │             │                                                        │   │
│  │      ┌──────┴──────┐                                                │   │
│  │      ▼             ▼                                                │   │
│  │ ┌──────────┐ ┌──────────┐                                          │   │
│  │ │FloorMgr  │ │StoreMgr  │ ←── 业务管理器，封装具体操作               │   │
│  │ │楼层管理器│ │店铺管理器│                                          │   │
│  │ └────┬─────┘ └────┬─────┘                                          │   │
│  └──────┼────────────┼──────────────────────────────────────────────────┘   │
│         │            │                                                      │
│         ▼            ▼                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         注册表 (Registry)                            │   │
│  │                                                                      │   │
│  │  ┌────────────────────────┐    ┌────────────────────────┐          │   │
│  │  │ SemanticObjectRegistry │    │     MeshRegistry       │          │   │
│  │  │     语义对象注册表      │◄──►│     Mesh 注册表        │          │   │
│  │  │                        │    │                        │          │   │
│  │  │ • objectsById (ID索引) │    │ • meshBySemanticId     │          │   │
│  │  │ • idsByType (类型索引) │    │ • semanticIdByMeshUuid │          │   │
│  │  │ • idByBusinessId       │    │                        │          │   │
│  │  └────────────────────────┘    └────────────────────────┘          │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│         ▲                                    ▲                              │
│         │ 注册                               │ 绑定                         │
│         │                                    │                              │
│  ┌──────┴────────────────────────────────────┴──────────────────────────┐   │
│  │                          工厂 (Factory)                               │   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │              SemanticObjectFactory 语义对象工厂              │    │   │
│  │  │                                                              │    │   │
│  │  │  • createFromStore(store)  → 创建店铺语义对象                │    │   │
│  │  │  • createFromFloor(floor)  → 创建楼层语义对象                │    │   │
│  │  │  • createFromArea(area)    → 创建区域语义对象                │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │                          行为 (Behaviors)                             │   │
│  │                                                                       │   │
│  │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐        │   │
│  │  │HighlightBehavior│ │NavigationBehavior│ │SceneQueryBehavior│ ⭐新增 │   │
│  │  │   高亮行为       │ │   导航行为       │ │   场景查询行为   │        │   │
│  │  └─────────────────┘ └─────────────────┘ └─────────────────┘        │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │                          事件 (Events) ⭐新增                          │   │
│  │                                                                       │   │
│  │  ┌─────────────────────┐    ┌─────────────────────┐                  │   │
│  │  │ DomainEventHandler  │    │   DomainEventBus    │                  │   │
│  │  │   事件翻译器         │───►│    领域事件总线     │                  │   │
│  │  │                     │    │                     │                  │   │
│  │  │ scene.click → store.│    │ • on(type, cb)      │                  │   │
│  │  │   selected          │    │ • emit(type, data)  │                  │   │
│  │  └─────────────────────┘    └─────────────────────┘                  │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│         ▲                                                                   │
│         │ 业务数据输入                                                       │
│         │                                                                   │
└─────────┼───────────────────────────────────────────────────────────────────┘
          │
    ┌─────┴─────┐
    │ Mall 数据  │  (业务实体: Mall / Floor / Area / Store)
    └───────────┘
```

### 3.2 双向绑定机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     为什么需要双向绑定？                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【场景1】用户点击 3D 店铺 → 查询业务数据                                    │
│  ════════════════════════════════════════                                   │
│                                                                             │
│    用户点击        Mesh           MeshRegistry      SemanticObject          │
│       │             │                 │                  │                  │
│       │   点击      │                 │                  │                  │
│       ├────────────►│                 │                  │                  │
│       │             │  getSemanticId  │                  │                  │
│       │             ├────────────────►│                  │                  │
│       │             │                 │    getById       │                  │
│       │             │                 ├─────────────────►│                  │
│       │             │                 │                  │                  │
│       │◄────────────┴─────────────────┴──────────────────┤                  │
│       │         返回店铺详情（名称、描述、商品...）         │                  │
│                                                                             │
│  ────────────────────────────────────────────────────────────────────────   │
│                                                                             │
│  【场景2】AI 说"高亮星巴克" → 控制 3D 对象                                   │
│  ════════════════════════════════════════                                   │
│                                                                             │
│    AI 指令      SemanticRegistry    MeshRegistry         Mesh               │
│       │               │                  │                 │                │
│       │ getByBusinessId("starbucks")     │                 │                │
│       ├──────────────►│                  │                 │                │
│       │               │    getMesh       │                 │                │
│       │               ├─────────────────►│                 │                │
│       │               │                  │  应用高亮效果    │                │
│       │               │                  ├────────────────►│                │
│       │               │                  │                 │ ✨发光          │
│       │◄──────────────┴──────────────────┴─────────────────┤                │
│       │                    店铺在 3D 场景中高亮显示                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          双向绑定总结                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   方向1: Mesh → SemanticObject                                              │
│   ─────────────────────────────                                             │
│   用途: 点击 3D 对象后，查询它代表什么业务实体                                │
│   方法: meshRegistry.getSemanticId(mesh)                                    │
│                                                                             │
│   方向2: SemanticObject → Mesh                                              │
│   ─────────────────────────────                                             │
│   用途: 根据业务需求，控制 3D 对象（高亮、隐藏、动画）                         │
│   方法: meshRegistry.getMesh(semanticId)                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 SemanticObjectRegistry 三索引设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                  SemanticObjectRegistry 三索引设计                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   为什么需要三种索引？ → 不同查询场景需要 O(1) 快速查询                       │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     索引1: objectsById                               │   │
│   │                     按语义 ID 查询                                   │   │
│   │                                                                      │   │
│   │    Map<string, SemanticObject>                                      │   │
│   │    ┌────────────────────────┬─────────────────────────────────┐     │   │
│   │    │ "store_001"            │ { id, type, businessId, ... }   │     │   │
│   │    │ "store_002"            │ { id, type, businessId, ... }   │     │   │
│   │    │ "floor_1F"             │ { id, type, businessId, ... }   │     │   │
│   │    └────────────────────────┴─────────────────────────────────┘     │   │
│   │                                                                      │   │
│   │    用途: getById("store_001") → 直接获取对象                         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     索引2: idsByType                                 │   │
│   │                     按类型查询所有对象                                │   │
│   │                                                                      │   │
│   │    Map<SemanticType, Set<string>>                                   │   │
│   │    ┌────────────────────────┬─────────────────────────────────┐     │   │
│   │    │ SemanticType.STORE     │ Set { "store_001", "store_002" }│     │   │
│   │    │ SemanticType.FLOOR     │ Set { "floor_1F", "floor_2F" }  │     │   │
│   │    │ SemanticType.AREA      │ Set { "area_food", "area_shop" }│     │   │
│   │    └────────────────────────┴─────────────────────────────────┘     │   │
│   │                                                                      │   │
│   │    用途: getByType(STORE) → 获取所有店铺                             │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     索引3: idByBusinessId                            │   │
│   │                     按业务 ID 查询                                   │   │
│   │                                                                      │   │
│   │    Map<string, string>                                              │   │
│   │    ┌────────────────────────┬─────────────────────────────────┐     │   │
│   │    │ "starbucks_001"        │ "store_001"                     │     │   │
│   │    │ "uniqlo_002"           │ "store_002"                     │     │   │
│   │    └────────────────────────┴─────────────────────────────────┘     │   │
│   │                                                                      │   │
│   │    用途: AI 说 "高亮星巴克" → getByBusinessId("starbucks_001")       │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 HighlightBehavior 高亮行为

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      HighlightBehavior 高亮行为                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   职责: 连接语义层 (StoreManager) 和渲染层 (HighlightEffect)                 │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        架构位置                                      │   │
│   │                                                                      │   │
│   │    ┌─────────────────┐                                              │   │
│   │    │  StoreManager   │  ←── 语义层: 管理店铺选中/高亮状态             │   │
│   │    │  (领域层)        │                                              │   │
│   │    └────────┬────────┘                                              │   │
│   │             │                                                        │   │
│   │             ▼                                                        │   │
│   │    ┌─────────────────┐                                              │   │
│   │    │HighlightBehavior│  ←── 行为层: 协调语义与渲染                   │   │
│   │    │  (领域层)        │                                              │   │
│   │    └────────┬────────┘                                              │   │
│   │             │                                                        │   │
│   │             ▼                                                        │   │
│   │    ┌─────────────────┐                                              │   │
│   │    │ HighlightEffect │  ←── 渲染层: 实际应用高亮效果                 │   │
│   │    │  (引擎层)        │                                              │   │
│   │    └─────────────────┘                                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        调用流程                                      │   │
│   │                                                                      │   │
│   │    highlightBehavior.highlightStore(semanticId)                     │   │
│   │         │                                                            │   │
│   │         ├──► 1. meshRegistry.getMesh(semanticId)  获取 Mesh         │   │
│   │         │                                                            │   │
│   │         ├──► 2. storeManager.highlightStore(semanticId)  更新状态   │   │
│   │         │                                                            │   │
│   │         └──► 3. highlightEffect.setHover(mesh)  应用视觉效果         │   │
│   │                                                                      │   │
│   │    highlightBehavior.selectStore(semanticId)                        │   │
│   │         │                                                            │   │
│   │         ├──► 1. meshRegistry.getMesh(semanticId)                    │   │
│   │         │                                                            │   │
│   │         ├──► 2. storeManager.selectStore(semanticId)                │   │
│   │         │                                                            │   │
│   │         └──► 3. highlightEffect.setSelected(mesh)  橙黄色高亮        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.5 NavigationBehavior 导航行为

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      NavigationBehavior 导航行为                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   用户/AI: "导航到星巴克"                                                    │
│              │                                                              │
│              ▼                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  NavigationBehavior.navigateToStore('store_starbucks_001')          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│              │                                                              │
│              ▼                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 1: MeshRegistry.getMesh(semanticId)                           │   │
│   │          通过语义 ID 获取 3D 对象                                    │   │
│   │          返回: THREE.Mesh (星巴克的 3D 模型)                         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│              │                                                              │
│              ▼                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 2: calculateCameraPosition(mesh, config)                      │   │
│   │          计算相机应该移动到的目标位置                                │   │
│   │                                                                      │   │
│   │                       相机位置 (Camera)                              │   │
│   │                            ●                                         │   │
│   │                           /│                                         │   │
│   │                          / │ heightOffset = sin(angle) × dist       │   │
│   │                         /  │                                         │   │
│   │                        / angle                                       │   │
│   │                       /────┼─────────────────                        │   │
│   │                            │ depthOffset = cos(angle) × dist        │   │
│   │                            ● 目标中心 (Store Center)                 │   │
│   │                           ███ ← 店铺 Mesh                            │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│              │                                                              │
│              ▼                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 3: animateCameraTo(targetPos, lookAtPos, duration)            │   │
│   │          执行相机平滑移动动画                                        │   │
│   │                                                                      │   │
│   │  时间:     0ms ────────────────────────────────── 1000ms            │   │
│   │  progress: 0 ──────────────────────────────────────── 1             │   │
│   │  eased:    0 ═══════════════════════════════════════ 1              │   │
│   │            (easeOutCubic: 开始快，结束慢)                            │   │
│   │                                                                      │   │
│   │  相机位置:                                                           │   │
│   │            起点 ●━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━● 终点              │   │
│   │                 ↑                                ↑                  │   │
│   │            startPosition                   targetPosition           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│              │                                                              │
│              ▼                                                              │
│         相机到达目标位置，用户看到星巴克                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.6 DomainEventHandler 事件翻译器

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DomainEventHandler 事件翻译器                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   职责: 将底层 3D 场景事件翻译为业务领域事件                                  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        为什么需要事件翻译？                          │   │
│   │                                                                      │   │
│   │    渲染层事件 (Three.js)              领域层事件 (业务语义)          │   │
│   │    ┌─────────────────────┐          ┌─────────────────────┐         │   │
│   │    │ scene.click         │          │ store.selected      │         │   │
│   │    │ { object: Mesh,     │    →     │ { storeId: "sb001", │         │   │
│   │    │   point: Vector3 }  │          │   storeName: "星巴克"}│        │   │
│   │    └─────────────────────┘          └─────────────────────┘         │   │
│   │                                                                      │   │
│   │    UI 层不需要知道 Three.js 的存在！                                 │   │
│   │    只关心 "哪个店铺被点击了"                                         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        事件翻译流程                                  │   │
│   │                                                                      │   │
│   │    SceneEventEmitter                DomainEventHandler               │   │
│   │    (渲染层)                         (领域层)                         │   │
│   │         │                                │                           │   │
│   │         │  scene.click(mesh)             │                           │   │
│   │         ├───────────────────────────────►│                           │   │
│   │         │                                │                           │   │
│   │         │                    ┌───────────┴───────────┐               │   │
│   │         │                    │ 1. MeshRegistry       │               │   │
│   │         │                    │    .getSemanticId()   │               │   │
│   │         │                    │    mesh → semanticId  │               │   │
│   │         │                    └───────────┬───────────┘               │   │
│   │         │                                │                           │   │
│   │         │                    ┌───────────┴───────────┐               │   │
│   │         │                    │ 2. SemanticRegistry   │               │   │
│   │         │                    │    .getById()         │               │   │
│   │         │                    │    判断类型: STORE?   │               │   │
│   │         │                    └───────────┬───────────┘               │   │
│   │         │                                │                           │   │
│   │         │                    ┌───────────┴───────────┐               │   │
│   │         │                    │ 3. 发出领域事件       │               │   │
│   │         │                    │    emit('store.selected',│            │   │
│   │         │                    │      { storeId, ... })│               │   │
│   │         │                    └───────────────────────┘               │   │
│   │         │                                │                           │   │
│   │         │                                ▼                           │   │
│   │         │                         UI 层订阅者                        │   │
│   │         │                    (显示店铺详情面板)                       │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        支持的领域事件                                │   │
│   │                                                                      │   │
│   │    渲染层事件              领域事件                  触发场景        │   │
│   │    ─────────────────────────────────────────────────────────────    │   │
│   │    scene.click + STORE  → store.selected          点击店铺          │   │
│   │    scene.hover + STORE  → store.focused           悬停店铺          │   │
│   │    scene.hoverEnd       → store.unfocused         离开店铺          │   │
│   │    scene.click + AREA   → area.selected           点击区域          │   │
│   │    scene.click + FLOOR  → floor.selected          点击楼层          │   │
│   │    scene.click + null   → scene.backgroundClick   点击空白          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.7 领域事件发布-订阅机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      领域事件发布-订阅机制                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        DomainEventBus 事件总线                       │   │
│   │                                                                      │   │
│   │    ┌─────────────────────────────────────────────────────────────┐  │   │
│   │    │                     事件订阅者存储                           │  │   │
│   │    │                                                              │  │   │
│   │    │    Map<DomainEventType, Set<Callback>>                      │  │   │
│   │    │    ┌────────────────────┬────────────────────────────────┐  │  │   │
│   │    │    │ 'store.selected'   │ Set { callback1, callback2 }   │  │  │   │
│   │    │    │ 'store.focused'    │ Set { callback3 }              │  │  │   │
│   │    │    │ 'floor.selected'   │ Set { callback4, callback5 }   │  │  │   │
│   │    │    └────────────────────┴────────────────────────────────┘  │  │   │
│   │    └─────────────────────────────────────────────────────────────┘  │   │
│   │                                                                      │   │
│   │    API:                                                             │   │
│   │    • on(eventType, callback)    → 订阅事件，返回取消函数            │   │
│   │    • off(eventType, callback)   → 取消订阅                          │   │
│   │    • emit(eventType, data)      → 发布事件，通知所有订阅者          │   │
│   │    • once(eventType, callback)  → 订阅一次，触发后自动取消          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        使用示例                                      │   │
│   │                                                                      │   │
│   │    // UI 组件订阅店铺选中事件                                        │   │
│   │    const unsubscribe = domainEventBus.on('store.selected', (data) => {│  │
│   │      showStoreDetailPanel(data.storeId, data.storeName)             │   │
│   │    })                                                                │   │
│   │                                                                      │   │
│   │    // 组件卸载时取消订阅                                             │   │
│   │    onUnmounted(() => unsubscribe())                                 │   │
│   │                                                                      │   │
│   │    // DomainEventHandler 发布事件                                    │   │
│   │    domainEventBus.emit('store.selected', {                          │   │
│   │      storeId: 'store-001',                                          │   │
│   │      storeName: '星巴克',                                            │   │
│   │      semanticId: 'store_1_xxx'                                      │   │
│   │    })                                                                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.8 SceneQueryBehavior 场景查询行为

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     SceneQueryBehavior 场景查询行为                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   职责: 提供统一的场景查询接口，封装跨管理器的复杂查询逻辑                     │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        架构位置                                      │   │
│   │                                                                      │   │
│   │    ┌─────────────────────────────────────────────────────────────┐  │   │
│   │    │                    SceneQueryBehavior                        │  │   │
│   │    │                      (统一查询入口)                          │  │   │
│   │    └──────────────────────────┬──────────────────────────────────┘  │   │
│   │                               │                                      │   │
│   │              ┌────────────────┼────────────────┐                    │   │
│   │              ▼                ▼                ▼                    │   │
│   │    ┌──────────────┐  ┌──────────────┐  ┌────────────────────┐      │   │
│   │    │ StoreManager │  │ FloorManager │  │SemanticObjectRegistry│     │   │
│   │    │  店铺管理器   │  │  楼层管理器   │  │    语义对象注册表    │     │   │
│   │    └──────────────┘  └──────────────┘  └────────────────────┘      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        查询方法                                      │   │
│   │                                                                      │   │
│   │    店铺查询:                                                         │   │
│   │    • getStoreById(storeId)         → 按业务ID查询店铺                │   │
│   │    • getStoreBySemanticId(id)      → 按语义ID查询店铺                │   │
│   │    • getStoresByArea(areaId)       → 获取区域下所有店铺              │   │
│   │    • getFloorStores(floorId)       → 获取楼层下所有店铺              │   │
│   │    • getAllStores()                → 获取所有店铺                    │   │
│   │                                                                      │   │
│   │    楼层查询:                                                         │   │
│   │    • getFloorById(floorId)         → 按业务ID查询楼层                │   │
│   │    • getFloorByLevel(level)        → 按楼层编号查询 (1F, B1)         │   │
│   │    • getAllFloors()                → 获取所有楼层（按level排序）     │   │
│   │                                                                      │   │
│   │    区域查询:                                                         │   │
│   │    • getAreaById(areaId)           → 按业务ID查询区域                │   │
│   │    • getAreasByFloor(floorId)      → 获取楼层下所有区域              │   │
│   │    • getAllAreas()                 → 获取所有区域                    │   │
│   │                                                                      │   │
│   │    状态查询:                                                         │   │
│   │    • getSelectedStore()            → 获取当前选中的店铺              │   │
│   │    • getHighlightedStore()         → 获取当前高亮的店铺              │   │
│   │    • getCurrentFloor()             → 获取当前楼层                    │   │
│   │    • getStatistics()               → 获取场景统计信息                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        返回结果格式                                  │   │
│   │                                                                      │   │
│   │    DomainResult<StoreQueryResult>                                   │   │
│   │    ┌─────────────────────────────────────────────────────────────┐  │   │
│   │    │ {                                                            │  │   │
│   │    │   success: true,                                             │  │   │
│   │    │   data: {                                                    │  │   │
│   │    │     semanticObject: { id, type, businessId, ... },          │  │   │
│   │    │     businessData: { id, name, merchantId, ... }             │  │   │
│   │    │   }                                                          │  │   │
│   │    │ }                                                            │  │   │
│   │    └─────────────────────────────────────────────────────────────┘  │   │
│   │                                                                      │   │
│   │    失败时:                                                           │   │
│   │    ┌─────────────────────────────────────────────────────────────┐  │   │
│   │    │ {                                                            │  │   │
│   │    │   success: false,                                            │  │   │
│   │    │   error: { code: TARGET_NOT_FOUND, message: "店铺不存在" }   │  │   │
│   │    │ }                                                            │  │   │
│   │    └─────────────────────────────────────────────────────────────┘  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.9 NavigationBehavior 完整数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        NavigationBehavior 数据流                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  输入: semanticId = "store_starbucks_001"                                   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────┐                                                        │
│  │  MeshRegistry   │ ──→ mesh (THREE.Mesh)                                  │
│  └─────────────────┘                                                        │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────┐                                    │
│  │  getMeshCenter(mesh)                │                                    │
│  │  → Box3.setFromObject(mesh)         │                                    │
│  │  → box.getCenter()                  │                                    │
│  │  → center = (10, 0, 20)             │                                    │
│  └─────────────────────────────────────┘                                    │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────┐                                    │
│  │  calculateCameraPosition()          │                                    │
│  │  → heightOffset = sin(45°) × 15     │                                    │
│  │  → depthOffset = cos(45°) × 15      │                                    │
│  │  → targetPos = (10, 10.6, 30.6)     │                                    │
│  └─────────────────────────────────────┘                                    │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────┐                                    │
│  │  animateCameraTo()                  │                                    │
│  │  → requestAnimationFrame 循环       │                                    │
│  │  → lerpVectors 插值                 │                                    │
│  │  → camera.lookAt(center)            │                                    │
│  └─────────────────────────────────────┘                                    │
│         │                                                                   │
│         ▼                                                                   │
│  输出: 相机平滑移动到目标位置，俯视店铺                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 核心交互流程

### 4.1 用户点击店铺完整流程（含事件翻译）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       用户点击店铺 - 完整流程                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   👆 用户点击屏幕                                                            │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  1. 浏览器事件                                                       │   │
│   │     mousedown event → (clientX, clientY)                            │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  2. RaycasterManager 射线检测 (渲染层)                               │   │
│   │     屏幕坐标 → NDC → 射线投射 → 命中 Mesh                            │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  3. SceneEventEmitter 事件转换 (渲染层)                              │   │
│   │     底层 Mesh → emit('click', { object: mesh, point })              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  4. DomainEventHandler 事件翻译 (领域层) ⭐ 新增                      │   │
│   │                                                                      │   │
│   │     ┌─────────────────────────────────────────────────────────────┐ │   │
│   │     │  a. MeshRegistry.getSemanticId(mesh)                        │ │   │
│   │     │     mesh.uuid → semanticId                                  │ │   │
│   │     │                                                              │ │   │
│   │     │  b. SemanticRegistry.getById(semanticId)                    │ │   │
│   │     │     semanticId → SemanticObject { type: STORE, ... }        │ │   │
│   │     │                                                              │ │   │
│   │     │  c. 判断类型并发出领域事件                                   │ │   │
│   │     │     if (type === STORE) emit('store.selected', data)        │ │   │
│   │     └─────────────────────────────────────────────────────────────┘ │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  5. UI 层订阅者响应 (UI 层)                                          │   │
│   │                                                                      │   │
│   │     domainEventBus.on('store.selected', (data) => {                 │   │
│   │       // 显示店铺详情面板                                            │   │
│   │       showStorePanel(data.storeId, data.storeName)                  │   │
│   │       // 触发高亮行为                                                │   │
│   │       highlightBehavior.selectStore(data.semanticId)                │   │
│   │     })                                                               │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│   🏪 店铺高亮 + 显示店铺详情面板                                             │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   事件流向总结:                                                              │
│                                                                             │
│   浏览器事件 → 渲染层事件 → 领域层事件 → UI 层响应                           │
│   (click)     (scene.click)  (store.selected)  (显示面板)                   │
│                                                                             │
│   每一层只关心自己的抽象级别，实现了完美的关注点分离！                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 AI 导航指令完整流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      AI 导航指令 - 完整流程                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   🤖 AI: "带我去星巴克"                                                      │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  1. 意图识别 (待开发 P4)                                             │   │
│   │     "带我去星巴克" → { action: 'navigate', target: 'starbucks' }    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  2. SemanticObjectRegistry 查询                                      │   │
│   │     getByBusinessId('starbucks') → semanticId                       │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  3. NavigationBehavior 执行导航                                      │   │
│   │     navigateToStore(semanticId, { duration: 1000 })                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ├──► MeshRegistry.getMesh() → 获取 3D 对象                            │
│      │                                                                      │
│      ├──► calculateCameraPosition() → 计算目标相机位置                      │
│      │                                                                      │
│      └──► animateCameraTo() → 平滑移动相机                                  │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  4. HighlightBehavior 高亮目标                                       │   │
│   │     selectStore(semanticId) → 星巴克发光                             │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│   📍 相机移动到星巴克上方，店铺高亮显示                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 鼠标悬停交互流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        鼠标悬停交互流程                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   🖱️ 鼠标移动                                                               │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  SceneEventEmitter.handleMouseMove()                                │   │
│   │                                                                      │   │
│   │    当前悬停: null          当前悬停: meshA                           │   │
│   │         │                       │                                    │   │
│   │         ▼                       ▼                                    │   │
│   │    射线检测命中 meshA      射线检测命中 meshB                         │   │
│   │         │                       │                                    │   │
│   │         ▼                       ▼                                    │   │
│   │    emit('hover', meshA)    emit('hoverEnd', meshA)                  │   │
│   │                            emit('hover', meshB)                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  HighlightBehavior 响应                                              │   │
│   │                                                                      │   │
│   │    on('hover')     → highlightStore(semanticId)  → 灰色微光         │   │
│   │    on('hoverEnd')  → clearHighlight()            → 恢复原状         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 数据模型关系

### 5.1 商城数据层级

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          商城数据层级结构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                           Mall 商城                                  │   │
│   │   { id, name, address, floors: [...] }                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                    ┌───────────────┼───────────────┐                        │
│                    ▼               ▼               ▼                        │
│   ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐              │
│   │   Floor 1F      │ │   Floor 2F      │ │   Floor 3F      │              │
│   │   { level: 1,   │ │   { level: 2,   │ │   { level: 3,   │              │
│   │     areas: [] } │ │     areas: [] } │ │     areas: [] } │              │
│   └────────┬────────┘ └────────┬────────┘ └────────┬────────┘              │
│            │                   │                   │                        │
│     ┌──────┴──────┐     ┌──────┴──────┐     ┌──────┴──────┐                │
│     ▼             ▼     ▼             ▼     ▼             ▼                │
│  ┌──────┐     ┌──────┐ ...           ...   ...           ...               │
│  │ Area │     │ Area │                                                     │
│  │餐饮区│     │购物区│                                                     │
│  └──┬───┘     └──┬───┘                                                     │
│     │            │                                                          │
│  ┌──┴──┐      ┌──┴──┐                                                      │
│  ▼     ▼      ▼     ▼                                                      │
│ ┌───┐ ┌───┐ ┌───┐ ┌───┐                                                   │
│ │🏪│ │🏪│ │🏪│ │🏪│  Store 店铺                                           │
│ │星巴│ │肯德│ │优衣│ │耐克│                                                │
│ │克  │ │基  │ │库  │ │   │                                                │
│ └───┘ └───┘ └───┘ └───┘                                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 语义对象与 Mesh 映射

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     语义对象与 Mesh 映射关系                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   业务数据                语义对象                    3D 对象                │
│   (Store)            (SemanticObject)              (THREE.Mesh)            │
│                                                                             │
│  ┌─────────────┐     ┌─────────────────┐     ┌─────────────────┐           │
│  │ Store       │     │ SemanticObject  │     │ THREE.Mesh      │           │
│  │             │     │                 │     │                 │           │
│  │ id: "sb001" │ ──► │ id: "sem_001"   │ ──► │ uuid: "mesh_x"  │           │
│  │ name: 星巴克│     │ businessId:     │     │ geometry: Box   │           │
│  │ category:   │     │   "sb001"       │     │ material: ...   │           │
│  │   餐饮      │     │ type: STORE     │     │ position: (x,y,z)│          │
│  │ position:   │     │ boundingBox:    │     │ userData: {     │           │
│  │   (10,0,20) │     │   { min, max }  │     │   semanticId:   │           │
│  └─────────────┘     └─────────────────┘     │   "sem_001"     │           │
│                                              │ }               │           │
│                                              └─────────────────┘           │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        映射关系存储                                  │   │
│   │                                                                      │   │
│   │   SemanticObjectRegistry          MeshRegistry                      │   │
│   │   ┌───────────────────┐          ┌───────────────────┐              │   │
│   │   │ objectsById:      │          │ meshBySemanticId: │              │   │
│   │   │  "sem_001" → obj  │◄────────►│  "sem_001" → mesh │              │   │
│   │   │                   │          │                   │              │   │
│   │   │ idByBusinessId:   │          │ semanticIdByUuid: │              │   │
│   │   │  "sb001" → "sem_001"         │  "mesh_x" → "sem_001"            │   │
│   │   └───────────────────┘          └───────────────────┘              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 性能优化策略

### 6.1 渲染优化

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          渲染性能优化策略                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  1. 按需渲染 (On-Demand Rendering)                                   │   │
│   │                                                                      │   │
│   │     传统方式:                     优化后:                            │   │
│   │     每帧都渲染                    只在需要时渲染                      │   │
│   │     60fps × 全部帧               有变化才渲染                        │   │
│   │                                                                      │   │
│   │     ┌─────┬─────┬─────┬─────┐   ┌─────┬─────┬─────┬─────┐          │   │
│   │     │ ██  │ ██  │ ██  │ ██  │   │ ██  │     │     │ ██  │          │   │
│   │     │渲染 │渲染 │渲染 │渲染 │   │渲染 │跳过 │跳过 │渲染 │          │   │
│   │     └─────┴─────┴─────┴─────┘   └─────┴─────┴─────┴─────┘          │   │
│   │     GPU 100% 占用                GPU 按需使用                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  2. 几何体/材质缓存复用                                              │   │
│   │                                                                      │   │
│   │     无缓存:                       有缓存:                            │   │
│   │     100个相同方块                 100个方块共享1个几何体              │   │
│   │     = 100个 BoxGeometry          = 1个 BoxGeometry                  │   │
│   │     = 100份 GPU 内存              = 1份 GPU 内存                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  3. 对象池减少 GC                                                    │   │
│   │                                                                      │   │
│   │     无对象池:                     有对象池:                          │   │
│   │     频繁 new/delete              acquire/release 复用                │   │
│   │     GC 频繁触发                  GC 压力小                           │   │
│   │     帧率不稳定                   帧率稳定                            │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  4. 像素比率限制                                                     │   │
│   │                                                                      │   │
│   │     devicePixelRatio = Math.min(window.devicePixelRatio, 2)         │   │
│   │                                                                      │   │
│   │     4K 屏幕 (dpr=3):  限制为 2x  →  性能提升 56%                     │   │
│   │     视觉差异:         几乎不可察觉                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 资源生命周期

### 7.1 资源释放流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          资源生命周期管理                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      ThreeEngine.dispose()                           │   │
│   │                                                                      │   │
│   │    组件卸载时调用                                                    │   │
│   │         │                                                            │   │
│   │         ▼                                                            │   │
│   │    ┌─────────────────────────────────────────────────────────────┐  │   │
│   │    │  1. 停止渲染循环                                             │  │   │
│   │    │     cancelAnimationFrame(animationId)                       │  │   │
│   │    └─────────────────────────────────────────────────────────────┘  │   │
│   │         │                                                            │   │
│   │         ▼                                                            │   │
│   │    ┌─────────────────────────────────────────────────────────────┐  │   │
│   │    │  2. 遍历场景释放资源                                         │  │   │
│   │    │     scene.traverse((obj) => {                               │  │   │
│   │    │       obj.geometry?.dispose()   // 释放几何体               │  │   │
│   │    │       obj.material?.dispose()   // 释放材质                 │  │   │
│   │    │     })                                                       │  │   │
│   │    └─────────────────────────────────────────────────────────────┘  │   │
│   │         │                                                            │   │
│   │         ▼                                                            │   │
│   │    ┌─────────────────────────────────────────────────────────────┐  │   │
│   │    │  3. 释放渲染器                                               │  │   │
│   │    │     renderer.dispose()          // 释放 WebGL 上下文        │  │   │
│   │    │     renderer.forceContextLoss() // 强制释放 GPU 资源        │  │   │
│   │    └─────────────────────────────────────────────────────────────┘  │   │
│   │         │                                                            │   │
│   │         ▼                                                            │   │
│   │    ┌─────────────────────────────────────────────────────────────┐  │   │
│   │    │  4. 移除事件监听                                             │  │   │
│   │    │     window.removeEventListener('resize', ...)               │  │   │
│   │    └─────────────────────────────────────────────────────────────┘  │   │
│   │         │                                                            │   │
│   │         ▼                                                            │   │
│   │    ✅ 资源完全释放，无内存泄漏                                       │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

> 📝 本文档随项目进展持续更新
> 
> 最后更新：2024-12-20
